{% extends "base.html" %}

{% block title %}
    Registro Asesores
{% endblock title %}

{% block content %}        
    <div id="alert-message" class="alert-message"></div>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const alertMessage = document.getElementById('alert-message');
    
            {% if messages %}
                {% for message in messages %}
                    alertMessage.textContent = "{{ message }}";
                    alertMessage.classList.add('show');
    
                    setTimeout(() => {
                        alertMessage.classList.remove('show');
                    }, 3000); 
                {% endfor %}
            {% endif %}
        });
    </script>

    
    <div class="types">
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>

    <table style="width:100%; text-align:center; font-size:20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 style="margin: 0; text-align:center;">Lista de Asesores</h1>
    </div>
        <button type="submit" class="new-asesor" onclick="openListModal()">
            Nuevo asesor
        </button> 
        <br>
        <form method="get" class="search-form" style="display: flex; align-items: center;">
            <div style="position: relative; flex: 1;">
                <input type="text" name="search" placeholder="Buscar por nombre o cédula  " 
                       value="{{ search_query }}" class="search-input" 
                       style="width: 101%; padding: 10px 600px 10px 10px; border-radius: 15px; border: 3px solid #ccc;">
                <button type="submit" class="button-buscar" 
                        style="position: absolute; right: 10px; top: 45%; transform: translateY(-50%); 
                               background: none; border: none; cursor: pointer; padding: 5px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" 
                         stroke="#00008B" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                </button>
            </div>
        </form>
        <thead>
            <tr>
                <th>#</th>
                <th>Nombre</th>
                <th>Documento</th>
                <th>Sucursal</th>
                <th>Fecha Creado</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for asesor in asesores %}
                <tr style="background-color: {% cycle '#ffffff' '#f9f9f9' %}; height: 40px;">
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">{{ asesor.id}}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">{{ asesor.name }}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">{{ asesor.document }}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">{{ asesor.sucursal }}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">{{ asesor.dateCreated }}</td>

                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="form_id" value="form-update">
                            <button type="submit" 
                                    style="background-color:#b1def1; color: black; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-family: Georgia, 'Times New Roman', Times, serif;">
                                {% include "icons/edit.html" %}
                            </button>
                        </form>
                    </td>

                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">
                            <button type="button" onclick="openDeleteConfirmationModal({{ asesor.id }})" 
                                    style="background-color:#b1def1; color: black; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-family: Georgia, 'Times New Roman', Times, serif;">
                                {% include "icons/delete.html" %}
                            </button>
                    </td>

                
                </tr>
            {% endfor %}
        </tbody>
       
    </table>
     {% include 'paginator.html' %}
    </div>
   
    <div id="asesores-list-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width: 400px; background:white; border:1px solid #ccc; padding:20px; border-radius:8px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2); z-index:1000;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h1 style="margin: 0; font-size: 30px;">Formulario Asesor</h1>
            <button type="button" onclick="closeModal()" style="background:none; border:none; font-size:30px; cursor:pointer; color:black;">&times;</button>
        </div>
    <br>

    <form method="POST" class="form-created form-created-2">
        {% csrf_token %}
        <input type="hidden" name="form_id" value="form-created-asesor">
        {{ form.as_p }}
        <br>
        <button type="submit">Guardar</button>
    </form>

    </div>

    <div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:999;" onclick="closeModal()"></div>

    <div id="delete-confirm-modal" style="display:none; position:fixed; top:30%; left:30%; width:40%; background-color:#12171ad7; border:1px solid #ccc; padding:20px; z-index:1001; border-radius:8px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);">
        <h3 style="text-align:center;color: white;">Confirmar Eliminación</h3>
        <br>
        <p style="text-align:center;color: white;">¿Estás seguro de que deseas eliminar este asesor?</p>
        <br>
        <div style="text-align:center;">
            <button type="submit" onclick="deleteAsesorConfirmed()">Sí</button>
            <button type="submit" onclick="closeDeleteConfirmationModal()">No</button>
        </div>
    </div>

    {% if update %}  
        <div id="editAsesorModal" style="display:block; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width: 400px; background:white; border:1px solid #ccc; padding:20px; border-radius:8px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2); z-index:1000;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h1 style="margin: 0; font-size: 30px;">Editar Asesor</h1>
                <button type="button" onclick="closeEditModal()" style="background:none; border:none; font-size:30px; cursor:pointer; color:black;">&times;</button>
            </div>
            <form method="POST" class="form-created form-created-2">
                {% csrf_token %}
                <input type="hidden" name="form_id" value="form-update-asesor">
                {{ form.as_p }}
                <br>
                <button type="submit">Actualizar</button>
            </form>
    </div>
    {% endif %}}


    <div id="editModalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:999;" onclick="closeEditModal()"></div>
    

    <script>
        function openEditModal() {
            document.getElementById('editAsesorModal').style.display = 'block';
        }

        function openListModal() {
            document.getElementById('asesores-list-modal').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
    
        function closeModal() {
            document.getElementById('asesores-list-modal').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none'; 
            document.body.style.overflow = 'auto';
        }
    
        function openDeleteConfirmationModal(asesorId) {
            document.getElementById('delete-confirm-modal').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('delete-confirm-modal').dataset.asesorId = asesorId; 
        }
    
        function closeDeleteConfirmationModal() {
            document.getElementById('delete-confirm-modal').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none'; 
        }
    
        function deleteAsesorConfirmed() {
            const asesorId = document.getElementById('delete-confirm-modal').dataset.asesorId;
    
            fetch(`/eliminar-asesor/${asesorId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(response => {
                if (response.ok) {
                    alert("Asesor eliminado correctamente.");
                    location.reload(); 
                } else {
                    alert("Hubo un error al eliminar el asesor.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error de conexión al servidor.");
            });
        }
    
        document.getElementById('asesores-list-modal').addEventListener('click', function(event) {
            event.stopPropagation();
        });
        {% comment %} function openEditModal(asesorId) {
            fetch(`/obtener-asesor/${asesorId}/`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error("Error al obtener los datos del asesor.");
                })
                .then(data => {
                    document.getElementById('edit-asesor-id').value = asesorId;
                    document.getElementById('edit-name').value = data.name;
                    document.getElementById('edit-document').value = data.document;
                    document.getElementById('edit-sucursal').value = data.sucursal;
                    document.getElementById('editAsesorModal').style.display = 'block';
                    document.getElementById('editModalOverlay').style.display = 'block';
                    document.body.style.overflow = 'hidden';
                })
                .catch(error => {
                    console.error("Error al cargar los datos del asesor:", error);
                    alert("No se pudieron cargar los datos del asesor.");
                });
        } {% endcomment %}
        
        function closeEditModal() {
            document.getElementById('editAsesorModal').style.display = 'none';
            document.getElementById('editModalOverlay').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function saveAsesorEdits() {
            const asesorId = document.getElementById('edit-asesor-id').value;
            const name = document.getElementById('edit-name').value;
            const documentValue = document.getElementById('edit-document').value;
            const sucursal = document.getElementById('edit-sucursal').value;
        
            fetch(`/editar-asesor/${asesorId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ name, document: documentValue, sucursal }),
            })
                .then(response => {
                    if (response.ok) {
                        alert("Asesor editado correctamente.");
                        location.reload();
                    } else {
                        alert("Error al editar el asesor.");
                    }
                })
                .catch(error => {
                    console.error("Error al guardar los cambios del asesor:", error);
                    alert("Hubo un error al guardar los cambios.");
                });
        }

    </script>    
{% endblock content %}

